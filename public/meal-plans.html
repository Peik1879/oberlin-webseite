<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Speiseplan - Oberlinhaus Werkstatt Portal</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <a href="#main-content" class="skip-to-main">Zum Hauptinhalt springen</a>

  <header role="banner">
    <div class="container">
      <div class="header-logo">
        <div class="logo-circle">OH</div>
        <div class="header-content">
          <h1>Oberlinhaus Werkstatt</h1>
          <p class="header-subtitle">Einfach. √úbersichtlich. Barrierefrei.</p>
        </div>
      </div>
      <div class="header-user">
        <span id="user-name"></span>
        <button class="btn btn-secondary" id="logout-btn">Abmelden</button>
      </div>
    </div>
  </header>

  <main id="main-content">
    <div class="container">
      <h2>üçΩÔ∏è Speiseplan</h2>
      <p>Hier siehst du, was diese Woche zu essen gibt.</p>

      <div id="meal-plans-loading" style="text-align: center; padding: 2rem;">
        <div class="spinner"></div>
        <p>Wird geladen...</p>
      </div>

      <div id="meal-plans-container" style="display: none;">
        <button onclick="window.print()" class="btn btn-secondary" style="margin-bottom: 1rem;">üñ®Ô∏è Drucken</button>
        
        <div id="meal-plans-grid" class="grid"></div>
      </div>

      <div id="meal-plans-error" style="display: none;" class="alert alert-error"></div>
    </div>
  </main>

  <footer class="accessibility-footer">
    <button id="font-size-btn" aria-label="Schriftgr√∂√üe √§ndern">üî§ A</button>
    <button id="text-to-speech-btn" aria-label="Vorlesen" aria-pressed="false">üîä</button>
    <button id="easy-language-btn" aria-label="Leichte Sprache" aria-pressed="false">ABC</button>
  </footer>

  <script src="/js/accessibility.js" type="module"></script>
  <script src="/js/easy-language.js" type="module"></script>

  <script>
    const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];

    async function loadMealPlans() {
      try {
        const response = await fetch('/api/meal-plans');
        const mealPlans = await response.json();

        if (mealPlans.length === 0) {
          showMessage('Kein Speiseplan vorhanden', 'error');
          return;
        }

        const grid = document.getElementById('meal-plans-grid');
        grid.innerHTML = '';

        mealPlans.forEach((meal, index) => {
          const day = days[meal.day_of_week - 1] || `Tag ${meal.day_of_week}`;
          grid.innerHTML += `
            <div class="card">
              <h3 class="card-title">${day}</h3>
              <div style="margin: 1rem 0;">
                <strong>Hauptgang:</strong> ${meal.main_course}
              </div>
              ${meal.side_dish ? `
                <div style="margin: 0.5rem 0;">
                  <strong>Beilage:</strong> ${meal.side_dish}
                </div>
              ` : ''}
              ${meal.dessert ? `
                <div style="margin: 0.5rem 0;">
                  <strong>Nachtisch:</strong> ${meal.dessert}
                </div>
              ` : ''}
            </div>
          `;
        });

        document.getElementById('meal-plans-loading').style.display = 'none';
        document.getElementById('meal-plans-container').style.display = 'block';
      } catch (error) {
        showMessage('Fehler beim Laden des Speiseplans: ' + error.message, 'error');
      }
    }

    function showMessage(message, type) {
      document.getElementById('meal-plans-loading').style.display = 'none';
      const errorEl = document.getElementById('meal-plans-error');
      errorEl.textContent = message;
      errorEl.className = `alert alert-${type}`;
      errorEl.style.display = 'block';
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/';
    }

    document.getElementById('logout-btn').addEventListener('click', logout);
    document.getElementById('font-size-btn').addEventListener('click', toggleFontSize);
    document.getElementById('text-to-speech-btn').addEventListener('click', toggleTextToSpeech);
    document.getElementById('easy-language-btn').addEventListener('click', toggleEasyLanguage);

    // Init
    loadFontSizePreference();
    loadEasyLanguagePreference();
    
    // Load user info
    fetch('/api/auth/me')
      .then(r => r.json())
      .then(data => {
        document.getElementById('user-name').textContent = `${data.user.firstname} ${data.user.lastname}`;
        loadMealPlans();
      })
      .catch(() => window.location.href = '/');

    function toggleFontSize() {
      const html = document.documentElement;
      const currentSize = html.className;
      let newSize = currentSize === '' ? 'font-large' : currentSize === 'font-large' ? 'font-xlarge' : '';
      html.className = newSize;
      localStorage.setItem('fontSize', newSize);
    }

    function toggleTextToSpeech() {
      const btn = document.getElementById('text-to-speech-btn');
      const isActive = btn.getAttribute('aria-pressed') === 'true';
      btn.setAttribute('aria-pressed', !isActive);
      localStorage.setItem('textToSpeech', !isActive);
    }

    function toggleEasyLanguage() {
      const isActive = document.documentElement.getAttribute('data-easy-language') === 'true';
      const newState = !isActive;
      document.documentElement.setAttribute('data-easy-language', newState);
      localStorage.setItem('easyLanguage', newState);
      document.getElementById('easy-language-btn').setAttribute('aria-pressed', newState);
    }

    function loadFontSizePreference() {
      const savedSize = localStorage.getItem('fontSize');
      if (savedSize) document.documentElement.className = savedSize;
    }

    function loadEasyLanguagePreference() {
      if (localStorage.getItem('easyLanguage') === 'true') {
        document.documentElement.setAttribute('data-easy-language', 'true');
      }
    }
  </script>
</body>
</html>
